---
import {actions} from "astro:actions";
import Layout from '../layouts/Layout.astro';
import AddClipForm from "../components/AddClipForm";
import LoginSection from "../components/LoginSection.astro";
import ExplainerSection from "../components/ExplainerSection";
import ClipGridTile from "../components/ClipGridTile.astro";
import ClipListTile from "../components/ClipListTile.astro";

const data = [
  {
    clip: {
      "id": "PiliablePuzzledCoffeeCorgiDerp-13q3FVYaDNgF2tP_",
      "url": "https://www.twitch.tv/ravs_/clip/PiliablePuzzledCoffeeCorgiDerp-13q3FVYaDNgF2tP_",
      "embed_url": "https://clips.twitch.tv/embed?clip=PiliablePuzzledCoffeeCorgiDerp-13q3FVYaDNgF2tP_",
      "broadcaster_id": "38167015",
      "broadcaster_name": "Ravs_",
      "creator_id": "21801690",
      "creator_name": "No0Vad",
      "video_id": "2509712825",
      "game_id": "27471",
      "language": "en",
      "title": "Ravs' Minecraft Minute",
      "view_count": 79,
      "created_at": "2025-07-11T18:07:22Z",
      "thumbnail_url": "https://static-cdn.jtvnw.net/twitch-clips-thumbnails-prod/PiliablePuzzledCoffeeCorgiDerp-13q3FVYaDNgF2tP_/959dd362-4d9d-4e21-b195-79e4b510ef86/preview-480x272.jpg",
      "duration": 60,
      "vod_offset": 2346,
      "is_featured": false
    },
    vod: {
      "id": "2509712825",
      "stream_id": "324158355580",
      "user_id": "38167015",
      "user_login": "ravs_",
      "user_name": "Ravs_",
      "title": "Short N Sweaty (also Minecraft Minute POG) | Death Stranding 2: On The Beach 100%",
      "description": "",
      "created_at": "2025-07-11T17:27:53Z",
      "published_at": "2025-07-11T17:27:53Z",
      "url": "https://www.twitch.tv/videos/2509712825",
      "thumbnail_url": "https://static-cdn.jtvnw.net/cf_vods/d2nvs31859zcd8/058c001ee2de681c42d1_ravs__324158355580_1752254868//thumb/thumb0-%{width}x%{height}.jpg",
      "viewable": "public",
      "view_count": 2191,
      "language": "en",
      "type": "archive",
      "duration": "5h44m8s",
      "muted_segments": null
    }
  },
  {
    clip: {
      "id": "TentativeTardyTapirNotLikeThis-JDoi7INZNw4zTVcr",
      "url": "https://www.twitch.tv/hrry/clip/TentativeTardyTapirNotLikeThis-JDoi7INZNw4zTVcr",
      "embed_url": "https://clips.twitch.tv/embed?clip=TentativeTardyTapirNotLikeThis-JDoi7INZNw4zTVcr",
      "broadcaster_id": "27063689",
      "broadcaster_name": "Hrry",
      "creator_id": "183963393",
      "creator_name": "birdbot02",
      "video_id": "2510441793",
      "game_id": "1826300051",
      "language": "en",
      "title": "Minecraft Minute",
      "view_count": 58,
      "created_at": "2025-07-12T13:00:26Z",
      "thumbnail_url": "https://static-cdn.jtvnw.net/twitch-clips-thumbnails-prod/TentativeTardyTapirNotLikeThis-JDoi7INZNw4zTVcr/8b9c0b78-f337-46e9-babf-9a63f67d817d/preview-480x272.jpg",
      "duration": 57,
      "vod_offset": 1099,
      "is_featured": false
    },
    vod: {
      "id": "2510441793",
      "stream_id": "323059581817",
      "user_id": "27063689",
      "user_login": "hrry",
      "user_name": "Hrry",
      "title": "wr holder btw ✅speedrunning ✅ grand prix no rewind 1:35:29 [wr]✅",
      "description": "",
      "created_at": "2025-07-12T12:40:36Z",
      "published_at": "2025-07-12T12:40:36Z",
      "url": "https://www.twitch.tv/videos/2510441793",
      "thumbnail_url": "https://static-cdn.jtvnw.net/cf_vods/d3fi1amfgojobc/de7f5980d8eb67ef474c_hrry_323059581817_1752324031//thumb/thumb0-%{width}x%{height}.jpg",
      "viewable": "public",
      "view_count": 96,
      "language": "en",
      "type": "archive",
      "duration": "4h24m38s",
      "muted_segments": null
    }
  },
  {
    clip: {
      "id": "BlueBenevolentScorpionHumbleLife-0i1z7rYdElqeg0Q6",
      "url": "https://www.twitch.tv/inthelittlewood/clip/BlueBenevolentScorpionHumbleLife-0i1z7rYdElqeg0Q6",
      "embed_url": "https://clips.twitch.tv/embed?clip=BlueBenevolentScorpionHumbleLife-0i1z7rYdElqeg0Q6",
      "broadcaster_id": "12131870",
      "broadcaster_name": "InTheLittleWood",
      "creator_id": "71973374",
      "creator_name": "wil_co",
      "video_id": "2510507291",
      "game_id": "27471",
      "language": "en",
      "title": "Minecraft Minute",
      "view_count": 15,
      "created_at": "2025-07-12T14:41:17Z",
      "thumbnail_url": "https://static-cdn.jtvnw.net/twitch-clips-thumbnails-prod/BlueBenevolentScorpionHumbleLife-0i1z7rYdElqeg0Q6/7bdadabc-8542-4b71-85ab-fe692cfa4688/preview-480x272.jpg",
      "duration": 60,
      "vod_offset": 466,
      "is_featured": false
    },
    vod: {
      "id": "2510507291",
      "stream_id": "323063613433",
      "user_id": "12131870",
      "user_login": "inthelittlewood",
      "user_name": "InTheLittleWood",
      "title": "THE BIG GATHER-ATHON on Misadventures SMP",
      "description": "",
      "created_at": "2025-07-12T14:32:20Z",
      "published_at": "2025-07-12T14:32:20Z",
      "url": "https://www.twitch.tv/videos/2510507291",
      "thumbnail_url": "https://vod-secure.twitch.tv/_404/404_processing_%{width}x%{height}.png",
      "viewable": "public",
      "view_count": 25,
      "language": "en",
      "type": "archive",
      "duration": "3h0m26s",
      "muted_segments": null
    },
  },
  {
    clip: {
      "id": "CrepuscularEasyDinosaurPeanutButterJellyTime-9a24HZ8YB_or4ps_",
      "url": "https://www.twitch.tv/ravs_/clip/CrepuscularEasyDinosaurPeanutButterJellyTime-9a24HZ8YB_or4ps_",
      "embed_url": "https://clips.twitch.tv/embed?clip=CrepuscularEasyDinosaurPeanutButterJellyTime-9a24HZ8YB_or4ps_",
      "broadcaster_id": "38167015",
      "broadcaster_name": "Ravs_",
      "creator_id": "21801690",
      "creator_name": "No0Vad",
      "video_id": "2510582698",
      "game_id": "509658",
      "language": "en",
      "title": "Ravs' Minecraft Minute #2",
      "view_count": 5,
      "created_at": "2025-07-12T16:58:35Z",
      "thumbnail_url": "https://static-cdn.jtvnw.net/twitch-clips-thumbnails-prod/CrepuscularEasyDinosaurPeanutButterJellyTime-9a24HZ8YB_or4ps_/0b9b8e6e-337b-497c-a0e9-2aee8680c860/preview-480x272.jpg",
      "duration": 60,
      "vod_offset": 1757,
      "is_featured": false
    },
    vod: {
      "id": "2510582698",
      "stream_id": "323068081145",
      "user_id": "38167015",
      "user_login": "ravs_",
      "user_name": "Ravs_",
      "title": "Invano | Death Stranding 2 100% | Peak @ 8pm!",
      "description": "",
      "created_at": "2025-07-12T16:28:47Z",
      "published_at": "2025-07-12T16:28:47Z",
      "url": "https://www.twitch.tv/videos/2510582698",
      "thumbnail_url": "https://vod-secure.twitch.tv/_404/404_processing_%{width}x%{height}.png",
      "viewable": "public",
      "view_count": 1,
      "language": "en",
      "type": "archive",
      "duration": "1h6m30s",
      "muted_segments": null
    }
  }

]
const {user} = Astro.locals

const order = Astro.url.searchParams.get('order') ?? 'newestfirst'
/*
clip: {
  clipId: string
  clipUrl: string
  clipEmbedUrl: string
  clipTitle: string
  clipThumbnailUrl: string
  clipCreatedAt: string
  broadcasterId: string
  broadcasterName: string
  creatorId: string
  creatorName: string
  videoId: string
  vodOffset: number
  videoCreatedAt: string
}
*/
const {data: clips, error} = await Astro.callAction(actions.getClips, order)

const embedStr =  Astro.url.searchParams.get('embed') ?? 'false'

const embed = embedStr === 'true'


---

<Layout>
    <div class="max-w-[1200px] mx-auto p-8 flex flex-col gap-6">
      {user && (
              <AddClipForm client:only="solid-js"/>)}

      {error && (
              <div class="bg-red-500 text-white p-4 rounded-md shadow-md">
                  <p class="font-bold">Error:</p>
                  <p>{error.message || JSON.stringify(error)}</p>
              </div>
      )}

      {clips && (
              <div class="flex gap-4 mb-4 justify-center">
                  <a href="/?order=newestfirst"
                     class:list={[
                       {'underline': order === 'newestfirst'},
                       'button px-3 py-2 text-center font-minecraft',
                     ]}>
                      Newest First
                  </a>
                  <a href="/?order=oldestfirst"
                     class:list={[
                       {'underline': order === 'oldestfirst'},
                       'button px-3 py-2 text-center font-minecraft',
                     ]}>
                      Oldest First
                  </a>
                {
                  user && (
                                <a href="/api/auth/logout" class:list={[
                                  'button px-3 py-2 text-center font-minecraft',
                                ]}>Logout</a>
                  )
                }
              </div>

              <div id="clips-container">
                  <!-- Grid view will be shown when layout setting is "grid" -->
                  <div id="grid-view" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display: none;">
                    {clips.map(clip => (
                            <ClipGridTile clip={clip} embed={embed}/>
                    ))}
                  </div>

                  <!-- List view will be shown when layout setting is "list" -->
                  <div id="list-view" class="flex flex-col gap-4" style="display: none;">
                    {clips.map(clip => (
                            <ClipGridTile clip={clip} embed={embed}/>
                    ))}
                  </div>
              </div>

              <ExplainerSection client:only="solid-js"/>
      )}

        <script>
          // Function to apply layout setting from localStorage
          function applyLayoutSetting() {
            // Get layout setting from localStorage, default to "list" if not set
            const settings = JSON.parse(localStorage.getItem('minecraft-minute-settings') || '{"layout": "list"}');
            const layoutValue = settings.layout || 'list';

            // Get the view elements
            const gridView = document.getElementById('grid-view');
            const listView = document.getElementById('list-view');

            // Show the appropriate view based on the layout setting
            if (layoutValue === 'grid') {
              gridView.style.display = 'grid';
              listView.style.display = 'none';
            } else {
              gridView.style.display = 'none';
              listView.style.display = 'flex';
            }
          }

          // Apply layout setting when the page loads
          document.addEventListener('DOMContentLoaded', applyLayoutSetting);
        </script>

      {!user && (
              <LoginSection/>)}
    </div>
</Layout>
